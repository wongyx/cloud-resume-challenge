name: SBOM Scan

on:
  push:
    branches:
      - main
    paths:
      - 'backend/lambda_code/visitor_counter/requirements.txt'
      - 'tests/package.json'
      - 'tests/package-lock.json'
      - '.github/workflows/sbom_scan.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'backend/lambda_code/visitor_counter/requirements.txt'
      - 'tests/package.json'
      - 'tests/package-lock.json'
      - '.github/workflows/sbom_scan.yml'
  schedule:
    - cron: '0 0 1 * *' # Scan on every first day of each month
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: 'ap-southeast-1'
  SYFT_VERSION: 'latest'
  GRYPE_VERSION: 'latest'

jobs:
  scan-python-dependencies:
    name: Scan Python Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin ${{ env.SYFT_VERSION }}
          syft version
      
      - name: Generate Python SBOM (CycloneDX format)
        run: |
          cd backend/lambda_code/visitor_counter
          syft scan dir:. \
            --output cyclonedx-json=../../../sbom-python-${GITHUB_SHA:0:7}.json
      
      - name: Upload Python SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-python
          path: |
            sbom-python-*.json
          retention-days: 30

  scan-npm-dependencies:
    name: Scan NPM Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin ${{ env.SYFT_VERSION }}
          syft version
        
      - name: Install NPM dependencies
        run: |
          cd tests
          npm ci --include=dev
      
      - name: Generate NPM SBOM (CycloneDX format)
        run: |
          cd tests
          syft scan dir:./node_modules \
            --source-name cloud-resume-tests \
            --source-version 1.0.0 \
            --select-catalogers javascript-package-cataloger \
            --output cyclonedx-json=../sbom-npm-${GITHUB_SHA:0:7}.json
      
      - name: Upload NPM SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-npm
          path: |
            sbom-npm-*.json
          retention-days: 30

  vulnerability-scan:
    name: Vulnerability Scan with Grype
    needs: [scan-python-dependencies, scan-npm-dependencies]
    runs-on: ubuntu-latest
    # Only run vulnerability scan on pull requests, scheduled runs, or workflow dispatch
    if: github.event_name == 'pull_request' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Download Python SBOM
        uses: actions/download-artifact@v4
        with:
          name: sbom-python
          path: ./sbom-artifacts
      
      - name: Download NPM SBOM
        uses: actions/download-artifact@v4
        with:
          name: sbom-npm
          path: ./sbom-artifacts
      
      - name: Install Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin ${{ env.GRYPE_VERSION }}
          grype version
      
      - name: Scan Python SBOM for vulnerabilities
        id: grype-python
        run: |
          PYTHON_SBOM=$(ls ./sbom-artifacts/sbom-python-*.json | head -1)
          
          if [ -f "$PYTHON_SBOM" ]; then
            echo "Scanning Python dependencies for vulnerabilities..."
            grype sbom:"$PYTHON_SBOM" \
              --output json \
              --file grype-python-results.json \
              --fail-on high
            
            # Also generate human-readable report
            grype sbom:"$PYTHON_SBOM" \
              --output table \
              --file grype-python-report.txt
            
            echo "python_scan_passed=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Python SBOM file not found"
            echo "python_scan_passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        continue-on-error: true
      
      - name: Scan NPM SBOM for vulnerabilities
        id: grype-npm
        run: |
          NPM_SBOM=$(ls ./sbom-artifacts/sbom-npm-*.json | head -1)
          
          if [ -f "$NPM_SBOM" ]; then
            echo "Scanning NPM dependencies for vulnerabilities..."
            grype sbom:"$NPM_SBOM" \
              --output json \
              --file grype-npm-results.json \
              --fail-on high
            
            # Also generate human-readable report
            grype sbom:"$NPM_SBOM" \
              --output table \
              --file grype-npm-report.txt
            
            echo "npm_scan_passed=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ NPM SBOM file not found"
            echo "npm_scan_passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        continue-on-error: true
      
      - name: Upload Grype results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: grype-results
          path: |
            grype-*-results.json
            grype-*-report.txt
          retention-days: 30
      
      - name: Generate vulnerability summary
        if: always()
        run: |
          echo "## ðŸ”’ Vulnerability Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${GITHUB_SHA:0:7}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${GITHUB_REF_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Python vulnerabilities
          if [ -f "grype-python-results.json" ]; then
            echo "### ðŸ Python Dependencies" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            CRITICAL=$(jq '[.matches[] | select(.vulnerability.severity == "Critical")] | length' grype-python-results.json 2>/dev/null || echo "0")
            HIGH=$(jq '[.matches[] | select(.vulnerability.severity == "High")] | length' grype-python-results.json 2>/dev/null || echo "0")
            MEDIUM=$(jq '[.matches[] | select(.vulnerability.severity == "Medium")] | length' grype-python-results.json 2>/dev/null || echo "0")
            LOW=$(jq '[.matches[] | select(.vulnerability.severity == "Low")] | length' grype-python-results.json 2>/dev/null || echo "0")
            
            echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ”´ Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ  High | $HIGH |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ¡ Medium | $MEDIUM |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ¢ Low | $LOW |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ -f "grype-python-report.txt" ]; then
              echo "<details>" >> $GITHUB_STEP_SUMMARY
              echo "<summary>ðŸ“‹ View detailed Python report</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              cat grype-python-report.txt >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### ðŸ Python Dependencies" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ Scan failed or no results available" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # NPM vulnerabilities
          if [ -f "grype-npm-results.json" ]; then
            echo "### ðŸ“¦ NPM Dependencies" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            CRITICAL=$(jq '[.matches[] | select(.vulnerability.severity == "Critical")] | length' grype-npm-results.json 2>/dev/null || echo "0")
            HIGH=$(jq '[.matches[] | select(.vulnerability.severity == "High")] | length' grype-npm-results.json 2>/dev/null || echo "0")
            MEDIUM=$(jq '[.matches[] | select(.vulnerability.severity == "Medium")] | length' grype-npm-results.json 2>/dev/null || echo "0")
            LOW=$(jq '[.matches[] | select(.vulnerability.severity == "Low")] | length' grype-npm-results.json 2>/dev/null || echo "0")
            
            echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ”´ Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ  High | $HIGH |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ¡ Medium | $MEDIUM |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ¢ Low | $LOW |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ -f "grype-npm-report.txt" ]; then
              echo "<details>" >> $GITHUB_STEP_SUMMARY
              echo "<summary>ðŸ“‹ View detailed NPM report</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              cat grype-npm-report.txt >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### ðŸ“¦ NPM Dependencies" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ Scan failed or no results available" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Check scan results
        run: |
          PYTHON_PASSED="${{ steps.grype-python.outputs.python_scan_passed }}"
          NPM_PASSED="${{ steps.grype-npm.outputs.npm_scan_passed }}"
          
          if [[ "$PYTHON_PASSED" == "false" ]] || [[ "$NPM_PASSED" == "false" ]]; then
            echo "âŒ Vulnerability scan failed!"
            echo "Critical or High severity vulnerabilities detected."
            echo "Please review the scan results and update your dependencies."
            exit 1
          else
            echo "âœ… No critical or high severity vulnerabilities detected"
          fi
      
  upload-to-s3:
    name: Upload SBOMs to S3
    needs: [scan-python-dependencies, scan-npm-dependencies]
    runs-on: ubuntu-latest
    environment: prod
    # Only upload to S3 on push to main, scheduled runs, or manual dispatch
    if: github.event_name == 'push' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Download Python SBOM
        uses: actions/download-artifact@v4
        with:
          name: sbom-python
          path: ./sbom-artifacts
      
      - name: Download NPM SBOM
        uses: actions/download-artifact@v4
        with:
          name: sbom-npm
          path: ./sbom-artifacts
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-role
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Upload Python SBOM to S3
        run: |
          PYTHON_SBOM=$(ls ./sbom-artifacts/sbom-python-*.json | head -1)
          
          if [ -f "$PYTHON_SBOM" ]; then
            # Upload as latest
            aws s3 cp "$PYTHON_SBOM" \
              s3://${{ vars.SBOM_BUCKET_NAME }}/python/latest-sbom-python.json \
              --metadata "commit-sha=${GITHUB_SHA},branch=${GITHUB_REF_NAME},repository=${{ github.repository }}"
            
            echo "âœ… Python SBOM uploaded to S3"
            echo "ðŸ“¦ CycloneDX: s3://${{ vars.SBOM_BUCKET_NAME }}/python/latest-sbom-python.json"
          else
            echo "âŒ Python SBOM file not found"
            exit 1
          fi
      
      - name: Upload NPM SBOM to S3
        run: |
          NPM_SBOM=$(ls ./sbom-artifacts/sbom-npm-*.json | head -1)
          
          if [ -f "$NPM_SBOM" ]; then
            # Upload as latest
            aws s3 cp "$NPM_SBOM" \
              s3://${{ vars.SBOM_BUCKET_NAME }}/npm/latest-sbom-npm.json \
              --metadata "commit-sha=${GITHUB_SHA},branch=${GITHUB_REF_NAME},repository=${{ github.repository }}"
            
            echo "âœ… NPM SBOM uploaded to S3"
            echo "ðŸ“¦ CycloneDX: s3://${{ vars.SBOM_BUCKET_NAME }}/npm/latest-sbom-npm.json"
          else
            echo "âŒ NPM SBOM file not found"
            exit 1
          fi

  generate-summary:
    name: Generate SBOM Summary
    needs: [scan-python-dependencies, scan-npm-dependencies]
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'push'
    
    steps:
      - name: Download Python SBOM
        uses: actions/download-artifact@v4
        with:
          name: sbom-python
          path: ./sbom-artifacts
        continue-on-error: true
      
      - name: Download NPM SBOM
        uses: actions/download-artifact@v4
        with:
          name: sbom-npm
          path: ./sbom-artifacts
        continue-on-error: true
      
      - name: Generate Summary
        run: |
          echo "## ðŸ” SBOM Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${GITHUB_SHA:0:7}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${GITHUB_REF_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Event:** \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "./sbom-artifacts" ]; then
            echo "### ðŸ“¦ Generated SBOMs (CycloneDX Format)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if ls ./sbom-artifacts/sbom-python-*.json >/dev/null 2>&1; then
              PYTHON_SBOM=$(ls ./sbom-artifacts/sbom-python-*.json | head -1)
              if [ -f "$PYTHON_SBOM" ]; then
                PYTHON_COMPONENTS=$(jq -r '.components | length' "$PYTHON_SBOM" 2>/dev/null || echo "N/A")
                echo "- âœ… **Python Dependencies**: $PYTHON_COMPONENTS components" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "- âš ï¸ **Python Dependencies**: Failed to generate" >> $GITHUB_STEP_SUMMARY
            fi
            
            if ls ./sbom-artifacts/sbom-npm-*.json >/dev/null 2>&1; then
              NPM_SBOM=$(ls ./sbom-artifacts/sbom-npm-*.json | head -1)
              if [ -f "$NPM_SBOM" ]; then
                NPM_COMPONENTS=$(jq -r '.components | length' "$NPM_SBOM" 2>/dev/null || echo "N/A")
                echo "- âœ… **NPM Dependencies**: $NPM_COMPONENTS components" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "- âš ï¸ **NPM Dependencies**: Failed to generate" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“ S3 Location" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "s3://${{ vars.SBOM_BUCKET_NAME }}/" >> $GITHUB_STEP_SUMMARY
            echo "â”œâ”€â”€ python/" >> $GITHUB_STEP_SUMMARY
            echo "â”‚   â””â”€â”€ latest-sbom-python.json" >> $GITHUB_STEP_SUMMARY
            echo "â””â”€â”€ npm/" >> $GITHUB_STEP_SUMMARY
            echo "    â””â”€â”€ latest-sbom-npm.json" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

  notify-completion:
    name: Notify Scan Complete
    needs: [scan-python-dependencies, scan-npm-dependencies, generate-summary]
    runs-on: ubuntu-latest
    if: success() && github.event_name == 'push'
    
    steps:
      - name: Scan success
        run: |
          echo "âœ… SBOM scan completed successfully"
          echo "ðŸ“¦ SBOMs uploaded to S3 bucket: ${{ vars.SBOM_BUCKET_NAME }}"