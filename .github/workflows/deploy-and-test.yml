name: Deploy and Test

on:
  push:
    branches: [main]
    paths:
      - 'modules/**'
      - 'environments/**'
      - 'tests/**'
  workflow_dispatch:

env:
  AWS_REGION: ap-southeast-1
  TF_VERSION: 1.6.0

jobs:
  deploy-test:
    name: Deploy Test Environment
    runs-on: ubuntu-latest
    environment: test
    outputs:
      website_url: ${{ steps.outputs.outputs.website_url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        working-directory: ./environments/test
        run: terraform init

      - name: Terraform Plan
        working-directory: ./environments/test
        run: terraform plan

      - name: Terraform Apply
        working-directory: ./environments/test
        run: terraform apply -auto-approve

      - name: Get Website URL
        id: outputs
        working-directory: ./environments/test
        run: |
          CLOUDFRONT_DOMAIN=$(terraform output -raw cloudfront_domain_name)
          echo "website_url=https://$CLOUDFRONT_DOMAIN" >> $GITHUB_OUTPUT
          echo "Test Website: https://$CLOUDFRONT_DOMAIN"

  test-environment:
    name: Test - Test Environment
    needs: deploy-test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: Wait for CloudFront distribution
        run: sleep 60

      - name: Run Playwright Tests
        env:
          TEST_ENV: test
          TEST_WEBSITE_URL: ${{ needs.deploy-test.outputs.website_url }}
        run: npm test

      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-test
          path: playwright-report/
          retention-days: 30

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-test
          path: test-results/
          retention-days: 30

  deploy-prod:
    name: Deploy Production Environment
    needs: test-environment
    runs-on: ubuntu-latest
    environment: production
    if: github.ref == 'refs/heads/main'
    outputs:
      website_url: ${{ steps.outputs.outputs.website_url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        working-directory: ./environments/prod
        run: terraform init

      - name: Terraform Plan
        working-directory: ./environments/prod
        run: terraform plan

      - name: Terraform Apply
        working-directory: ./environments/prod
        run: terraform apply -auto-approve

      - name: Get Website URL
        id: outputs
        working-directory: ./environments/prod
        run: |
          CLOUDFRONT_DOMAIN=$(terraform output -raw cloudfront_domain_name)
          echo "website_url=https://$CLOUDFRONT_DOMAIN" >> $GITHUB_OUTPUT
          echo "Production Website: https://$CLOUDFRONT_DOMAIN"

  test-production:
    name: Test - Production Environment
    needs: deploy-prod
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: Wait for CloudFront distribution
        run: sleep 60

      - name: Run Playwright Tests
        env:
          TEST_ENV: prod
          PROD_WEBSITE_URL: ${{ needs.deploy-prod.outputs.website_url }}
        run: npm test

      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-prod
          path: playwright-report/
          retention-days: 30

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-prod
          path: test-results/
          retention-days: 30

      - name: Notify on Failure
        if: failure()
        run: |
          echo "‚ùå Production smoke tests failed!"
          echo "::error::Production deployment verification failed. Please investigate immediately."
          exit 1

